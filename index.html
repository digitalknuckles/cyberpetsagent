<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NFT-Gated AI Chat ‚Äî Cyberpets</title>

<style>
:root{
  --bg:#0b1020;
  --muted:#94a3b8;
  --accent:#7c3aed;
  --glass: rgba(255,255,255,0.03);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#e6eef8;
  overflow:hidden;
}

body::before{
  content:'';
  position:fixed;
  inset:0;
  background:url('https://ipfs.io/ipfs/bafkreihgxaa3mbxkm6db7o3yoa6zekht7lmg5atp7inxkhifdy6p3nxjui') center/cover no-repeat;
  opacity:0.6;
  pointer-events:none;
  z-index:0;
}

.app{
  max-width:720px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  position:relative;
  z-index:1;
}

header{
  padding:14px 16px;
  display:flex;
  align-items:center;
  gap:12px;
}

.brand{font-weight:700;font-size:24px;}
.subtitle{font-size:14px;color:var(--muted);}

.send{
  background:linear-gradient(135deg,#06b6d4,#7c3aed);
  border:none;
  padding:10px 14px;
  border-radius:12px;
  color:white;
  font-weight:700;
  cursor:pointer;
}

.send.blink{ animation: blink 1.2s infinite; }
@keyframes blink{ 0%,100%{opacity:1} 50%{opacity:.4} }

.pfp-overlay{
  position:fixed;
  top:20px;
  right:20px;
  width:100px;
  height:100px;
  border-radius:50%;
  overflow:hidden;
  border:2px solid rgba(255,255,255,0.15);
  background:var(--glass);
  z-index:20;
}
.pfp-overlay img{width:100%;height:100%;object-fit:cover;}

.nft-status{
  position:fixed;
  top:130px;
  right:30px;
  width:80px;
  height:15px;
  background:rgba(255,255,255,0.12);
  border-radius:3px;
  overflow:hidden;
  z-index:20;
}
.nft-status-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#16f5a6,#f43f5e);
  transition:width .3s ease;
}
.nft-status-fill.pulse{ animation:pulse 1s infinite; }
@keyframes pulse{ 0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)} }

/* NFT Carousel */
.nft-selector{
  position:fixed;
  top:150px;
  right:20px;
  display:flex;
  flex-direction:column;   /* ‚¨ÖÔ∏è vertical */
  gap:10px;
  max-height:calc(100vh - 140px);
  overflow-y:auto;         /* ‚¨ÖÔ∏è vertical scroll */
  padding-right:4px;
  z-index:21;
}
.nft-selector::-webkit-scrollbar{ height:6px; }
.nft-selector::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.25);
  border-radius:4px;
}
.nft-selector img{
  width:56px;
  height:56px;
  border-radius:14px;
  object-fit:cover;
  border:2px solid rgba(255,255,255,0.15);
  cursor:pointer;
  transition:all 0.2s ease;
}
.nft-selector img.selected{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(124,58,237,.35);
  transform:scale(1.08);
}

/* CHAT */
main.chat-area{
  flex:1;
  overflow-y:auto;
  padding:16px;
  padding-bottom:240px;
}

.messages{ display:flex; flex-direction:column; gap:10px; }

.msg{
  max-width:86%;
  padding:12px;
  border-radius:14px;
  font-size:15px;
}

.msg.ai{ background:rgba(17,24,39,0.75); }
.msg.user{
  background:linear-gradient(135deg,#7c3aed,#06b6d4);
  align-self:flex-end;
  color:white;
}

.meta{ font-size:12px; color:var(--muted); margin-bottom:6px; }

/* COMPOSER */
.composer{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  padding:14px;
  display:flex;
  gap:8px;
  background:linear-gradient(180deg,rgba(11,16,32,.6),rgba(7,10,18,.85));
  backdrop-filter:blur(12px);
}

.input{
  flex:1;
  background:transparent;
  border:1px solid rgba(255,255,255,.12);
  padding:12px;
  border-radius:14px;
  color:inherit;
}

.avatar{
  position:absolute;
  width:200px;
  height:200px;
  background:url('https://ipfs.io/ipfs/bafybeid54iqakrphe2yc323kgpnn7r4wubeckxt2fdy4dj3hrhpc2iwxqa') center/contain no-repeat;
  pointer-events:none;
  animation:bounce 1s ease-in-out infinite alternate;
  z-index:1;
}
.avatar.typing{ animation:bounce .3s infinite alternate; }
@keyframes bounce{ from{transform:translateY(0)} to{transform:translateY(-10px)} }

.loading-spinner{
  width:24px;height:24px;border:3px solid rgba(255,255,255,.15);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
/* Make PFP clickable */
.pfp-overlay {
  cursor: pointer;
  transition: transform 0.15s ease;
}
.pfp-overlay:hover {
  transform: scale(1.05);
}

/* Dropdown container */
.nft-dropdown {
  position: fixed;
  top: 88px;
  right: 12px;
  width: 220px;
  max-height: 360px;
  background: rgba(11,16,32,0.95);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 16px;
  backdrop-filter: blur(14px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.45);
  z-index: 30;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: dropdownIn 0.18s ease-out;
}

@keyframes dropdownIn {
  from { opacity:0; transform: translateY(-8px) scale(0.98); }
  to { opacity:1; transform: none; }
}

.nft-dropdown.hidden {
  display: none;
}

.nft-dropdown-header {
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  color: var(--muted);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

/* Vertical selector list */
.nft-dropdown-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px;
  overflow-y: auto;
}

/* NFT item */
.nft-dropdown-list img {
  width: 100%;
  height: 48px;
  object-fit: cover;
  border-radius: 12px;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.08);
  transition: all 0.15s ease;
}

.nft-dropdown-list img:hover {
  transform: translateX(2px);
  border-color: rgba(124,58,237,0.6);
}

.nft-dropdown-list img.selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(124,58,237,0.4);
}
@media (max-width: 640px) {
  .nft-status {
    position: relative;
    top: auto;
    right: auto;
    width: 80%;
    margin: 0 auto 12px auto;
    z-index: 1;
  }
}
@media (max-width: 640px) {
  .pfp-overlay {
    position: relative;
    top: auto;
    right: auto;
    left: auto;

    width: 96px;
    height: 96px;

    margin: 12px auto 8px auto;

    z-index: 1;
  }
}
/* Collect New CTA */
.collect-new {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  width: 100%;
  padding: 14px 12px;
  margin-top: 12px;

  border-radius: 14px;
  text-decoration: none;

  background: linear-gradient(135deg, #06b6d4, #7c3aed);
  color: white;
  font-weight: 800;
  font-size: 14px;

  animation: blink 1.2s infinite;
}

.collect-new span {
  font-size: 11px;
  font-weight: 500;
  opacity: 0.85;
  margin-top: 4px;
}

/* Optional hover polish */
.collect-new:hover {
  transform: translateY(-1px);
  filter: brightness(1.05);
}
.nft-item{
  position: relative;
  display: inline-block;
}
/*Nft rarity Badge*/
.rarity-badge{
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  padding: 2px 8px;
  font-size: 10px;
  font-weight: 700;
  color: #020617;
  border-radius: 999px;
  white-space: nowrap;
}

</style>
</head>

<body>
<div class="app">
<header>
  <div>
    <div class="brand">Cyberpets AI</div>
    <div class="subtitle">NFT-gated assistant</div>
  </div>
  <button id="connectBtn" class="send blink" style="margin-left:auto">Connect Wallet</button>
</header>

<div class="pfp-overlay" id="pfpToggle">
  <img id="pfpImg" />
</div>

<div class="nft-dropdown hidden" id="nftDropdown">
  <div class="nft-dropdown-list" id="nftSelector"></div>
</div>

<div class="nft-status"><div id="nftStatusFill" class="nft-status-fill"></div></div>


<main class="chat-area">
  <div class="messages" id="messages"></div>
</main>

<div class="composer">
  <input id="input" class="input" disabled placeholder="Ask Your CyberpetAi Anything..." />
  <button id="send" class="send" disabled>Send</button>
</div>

<div class="avatar" id="avatar"></div>


<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONFIG = {
  NFT_CONTRACT: "0x1C37df48Fa365B1802D0395eE9F7Db842726Eb81",
  NFT_TOKEN_ID: null,
  API_BASE: "",
  ENABLE_SESSION_RESTORE: false // ‚¨ÖÔ∏è disable missing endpoint
};

//-----------DOMs lookup---------------
const connectBtn = document.getElementById('connectBtn');
const sendBtn = document.getElementById('send');
const inputEl = document.getElementById('input');
const messages = document.getElementById('messages');
const nftFill = document.getElementById('nftStatusFill');
const pfpImg = document.getElementById('pfpImg');
const nftSelectorEl = document.getElementById('nftSelector');
const DEFAULT_PFP =
  'https://ipfs.io/ipfs/bafybeiejwxn2wb3rnw6qi5ahwd64zmj7ufhhgnbgw7x2bl4ag4zeabglzm';

const pfpToggle = document.getElementById('pfpToggle');
const nftDropdown = document.getElementById('nftDropdown');

let avatar = document.getElementById('avatar');
let web3Provider = null;
let signer = null;
let userAddress = null;
let prompts = 0;

let hasNFTAccess = false;
let authAnnounced = false;

let ownedNFTs = [];
let activeNFT = null;

let rarityTable = new Map();

if (pfpImg) {
  pfpImg.src = DEFAULT_PFP;
}

/* ---------------- UTIL ---------------- */
function scrollBottom(){
  messages.parentElement.scrollTop = messages.parentElement.scrollHeight;
}

function escapeHtml(u=''){
  return String(u)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('\n','<br/>');
}

function bindAvatarTo(el){
  if(!avatar || !el) return;
  const msgRect = el.getBoundingClientRect();
  const appRect = document.querySelector('.app').getBoundingClientRect();
  const composerRect = document.querySelector('.composer').getBoundingClientRect();

  let top = msgRect.top - appRect.top - 30;
  const maxTop = composerRect.top - appRect.top - 220;
  if(top > maxTop) top = maxTop;

  avatar.style.left = '-140px';
  avatar.style.top = top + 'px';
}

function push(who,text){
  const m=document.createElement('div');
  m.className='msg '+(who==='User'?'user':'ai');
  m.innerHTML=`<div class="meta">${who}</div>${text}`;
  messages.appendChild(m);
  scrollBottom();
  if(who !== 'User' && avatar){
    requestAnimationFrame(()=>bindAvatarTo(m));
  }
  return m;
}

function incrementNFTStatus(){
  prompts++;
  nftFill.style.width = Math.min(prompts*10,100)+'%';
  if(prompts>=10) nftFill.classList.add('pulse');
}

/* ---------------- NFT DROPDOWN TOGGLE ---------------- */
pfpToggle?.addEventListener('click', (e) => {
  e.stopPropagation();
  nftDropdown?.classList.toggle('hidden');
});

document.addEventListener('click', (e) => {
  if (
    nftDropdown &&
    !nftDropdown.contains(e.target) &&
    !pfpToggle.contains(e.target)
  ) {
    nftDropdown.classList.add('hidden');
  }
});

//-------------Collect new NFT Button------------
function appendCollectNewButton(container){
  if (!container) return;

  // Prevent duplicates
  if (container.querySelector('.collect-new')) return;

  const a = document.createElement('a');
  a.href = 'https://opensea.io/collection/cyberpetsai';
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.className = 'collect-new';

  a.innerHTML = `
    Collect New
    <span>Go To OpenSea.io</span>
  `;

  container.appendChild(a);
}

function getRarityLabel(nft){
  const count = Array.isArray(nft.traits) ? nft.traits.length : 0;

  if (count >= 8) return { label:'Legendary', color:'#facc15' };
  if (count >= 6) return { label:'Rare', color:'#38bdf8' };
  if (count >= 4) return { label:'Uncommon', color:'#34d399' };
  return { label:'Common', color:'#94a3b8' };
}

function aiReactToNFTSwitch(nft){
  if(!nft) return;

  const rarityData = rarityTable.get(nft.tokenId.toString());
  const rarityText = rarityData ? `Rarity: ${rarityData.rarity_percent.toFixed(1)}% (Rank #${rarityData.rank})` : '';

  const traitSummary = (nft.traits || [])
    .slice(0,3)
    .map(t => `${t.trait_type}: ${t.value}`)
    .join(', ');

  const lines = [
    `üîÑ Cyberpet switched.`,
    `<b>${escapeHtml(nft.name)}</b> is now active.`,
    traitSummary ? `Key traits: ${escapeHtml(traitSummary)}` : '',
    rarityText
  ].filter(Boolean).join('<br/>');

  push('AI', lines);
}

/* ---------------- NFT SELECTOR ---------------- */
function renderNFTSelector(nfts, activeTokenId=null){
  if(!Array.isArray(nfts) || !nfts.length) return;
  if(!nftSelectorEl) return;
  nftSelectorEl.innerHTML = '';

  nfts.forEach(nft=>{
  const rarity = getRarityLabel(nft);

  const wrapper = document.createElement('div');
  wrapper.className = 'nft-item';

  const img = document.createElement('img');
  img.src = nft.image;
  img.title = nft.name;
  img.className = 'nft-thumb';
  if(activeTokenId && nft.tokenId === activeTokenId){
    img.classList.add('selected');
  }
  img.onclick = ()=>selectNFT(nft);

  // Badge with % (from rarity table)
  const badge = document.createElement('div');
  badge.className = 'rarity-badge';
  badge.textContent = rarity.label; // e.g., "99.97%"
  badge.style.background = rarity.color;

  wrapper.appendChild(img);
  wrapper.appendChild(badge);
  nftSelectorEl.appendChild(wrapper);
});

  if(!activeNFT && nfts[0]) selectNFT(nfts[0], true);

  appendCollectNewButton(nftSelectorEl);
}

function selectNFT(nft, silent = false){
  // üö´ prevent spam
  if(activeNFT?.tokenId === nft.tokenId) return;
  // üõë Do nothing if already active
  if(activeNFT && activeNFT.tokenId === nft.tokenId){
    return;
  }

  activeNFT = nft;
  CONFIG.NFT_TOKEN_ID = nft.tokenId;
    // ‚úÖ replace placeholder ONLY after verified NFT selection
  if (pfpImg && nft?.image) {
    pfpImg.src = nft.image;
  }

  localStorage.setItem('activeNFT', nft.tokenId);

  if(nftDropdown){
    nftDropdown.classList.add('hidden');
  }

  // Highlight selected thumbnail
  if(nftSelectorEl){
    [...nftSelectorEl.children].forEach(img=>{
      img.classList.toggle(
        'selected',
        img.title === nft.name
      );
    });
  }

  // Announce ONLY on real user-driven change
  if(!silent){
    push(
      'System',
      `Selected <b>${escapeHtml(nft.name)}</b> as your active Cyberpet üêæ`
    );
     aiReactToNFTSwitch(nft); // üß† AI reaction
  }
}

/* ---------------- WALLET ---------------- */
async function connectWallet(){
  if(!window.ethereum) return alert('No Ethereum wallet detected');

  const accounts = await ethereum.request({ method:'eth_requestAccounts' });
  if(!accounts.length) return;

  web3Provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = web3Provider.getSigner();
  userAddress = accounts[0].toLowerCase();

  connectBtn.classList.remove('blink');
  connectBtn.textContent =
    `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

  await authenticateAndFetchNFT();
}

/* Silent restore */
async function restoreWalletConnection(){
  if(!window.ethereum) return;

  const accounts = await ethereum.request({ method:'eth_accounts' });
  if(!accounts.length) return;

  web3Provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = web3Provider.getSigner();
  userAddress = accounts[0].toLowerCase();

  connectBtn.classList.remove('blink');
  connectBtn.textContent =
    `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
}

/* ---------------- AUTH ---------------- */
async function authenticateAndFetchNFT(){
  if(!userAddress) return;

  const r = await fetch(`${CONFIG.API_BASE}/api/auth`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ address:userAddress }),
    credentials:'include'
  });

  const data = await r.json();
  handleNFTAuth(data);
}

function handleNFTAuth(data){
  ownedNFTs = Array.isArray(data?.nfts) ? data.nfts : [];

  // -------- NO NFT CASE --------
  if(!ownedNFTs.length){
    if(hasNFTAccess || !authAnnounced){
      hasNFTAccess = false;
      authAnnounced = true;

      inputEl.disabled = true;
      sendBtn.disabled = true;

        if (pfpImg) {
        pfpImg.src = DEFAULT_PFP;
      }

      push('System', `
        You need a <b>CyberpetsAi NFT</b> to continue.<br/><br/>
        <a href="https://opensea.io/collection/cyberpetsai" target="_blank"
           style="display:inline-block;padding:10px 14px;border-radius:12px;
           background:linear-gradient(135deg,#06b6d4,#7c3aed);
           color:white;font-weight:700;text-decoration:none;">
           Go To NFTs
        </a>
      `);
    }
    return;
  }

  // -------- HAS NFT CASE --------
  if(!hasNFTAccess){
    hasNFTAccess = true;
    authAnnounced = true;

    inputEl.disabled = false;
    sendBtn.disabled = false;

    const storedToken = localStorage.getItem('activeNFT');
    renderNFTSelector(ownedNFTs, storedToken || data.activeTokenId);

    push('System', `Chat unlocked ‚Äî ${ownedNFTs.length} Cyberpets verified üêæ`);
  }
}

/* ---------------- SESSION RESTORE ---------------- */
async function restoreSession(){
  if(!CONFIG.ENABLE_SESSION_RESTORE) return; // ‚¨ÖÔ∏è prevent 404

  try{
    const r = await fetch('/api/session',{ credentials:'include' });
    if(!r.ok) return;

    const data = await r.json();
    userAddress = data.address;
    ownedNFTs = data.nfts || [];

    connectBtn.classList.remove('blink');
    connectBtn.textContent =
      `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

    const storedToken = localStorage.getItem('activeNFT');
    renderNFTSelector(ownedNFTs, storedToken || data.activeTokenId);

    inputEl.disabled = false;
    sendBtn.disabled = false;

    push('System','Session restored ‚Äî welcome back üêæ');
  }catch{}
}

/* ---------------- AUTO AUTH ---------------- */
async function autoAuthIfNeeded(){
  if(!userAddress) return;
  if(ownedNFTs.length) return;
  await authenticateAndFetchNFT();
}

/* ---------------- CHAT ---------------- */
async function sendMessage(){
  const t=inputEl.value.trim();
  if(!t) return;

  push('User', escapeHtml(t));
  inputEl.value='';
  sendBtn.disabled = true;
  if(avatar) avatar.classList.add('typing');

  const p = push('AI', '<span class="loading-spinner"></span>');

  try{
    // Get rarity data for active NFT
    let rarityData = null;
    if(activeNFT){
      rarityData = rarityTable.get(activeNFT.tokenId.toString());
    }

    const r = await fetch(`${CONFIG.API_BASE}/api/chat`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        input: t,
        activeTokenId: activeNFT?.tokenId,
        rarity: rarityData || null  // <-- send rarity info to backend
      }),
      credentials: 'include'
    });

    const d = await r.json();
    p.innerHTML = `<div class="meta">AI</div>${escapeHtml(d.text || 'No response')}`;
    requestAnimationFrame(() => bindAvatarTo(p));
    incrementNFTStatus();
  } catch(err){
    console.error(err);
    p.innerHTML = '<div class="meta">AI</div>Error contacting AI backend.';
  } finally {
    sendBtn.disabled = false;
    if(avatar) avatar.classList.remove('typing');
  }
}

async function loadRarityTable() {
  try {
    const r = await fetch('rarity_results.json'); // adjust path if needed
    const data = await r.json();
    // Map tokenID ‚Üí rarity data for fast lookup
    data.forEach(nft => rarityTable.set(nft.tokenID.toString(), nft));
  } catch (err) {
    console.warn('Failed to load rarity table', err);
  }
}

function getRarityLabel(nft){
  const rarityData = rarityTable.get(nft.tokenId.toString());

  if(rarityData){
    let color = '#94a3b8'; // default Common
    if(rarityData.rarity_percent >= 90) color = '#facc15'; // Legendary
    else if(rarityData.rarity_percent >= 70) color = '#38bdf8'; // Rare
    else if(rarityData.rarity_percent >= 40) color = '#34d399'; // Uncommon

    return {
      label: `${rarityData.rarity_percent.toFixed(1)}%`,
      color: color,
      score: rarityData.rarity_score,
      rank: rarityData.rank
    };
  }

  // fallback to trait count
  const count = Array.isArray(nft.traits) ? nft.traits.length : 0;
  if (count >= 8) return { label:'Legendary', color:'#facc15' };
  if (count >= 6) return { label:'Rare', color:'#38bdf8' };
  if (count >= 4) return { label:'Uncommon', color:'#34d399' };
  return { label:'Common', color:'#94a3b8' };
}
/* ---------------- INIT ---------------- */
document.addEventListener('DOMContentLoaded',()=>{
  if(!avatar) avatar = document.getElementById('avatar');
  loadRarityTable();
});


connectBtn.onclick = connectWallet;
sendBtn.onclick = sendMessage;
inputEl.addEventListener('keydown',e=>{
  if(e.key==='Enter') sendMessage();
});

push('System','Welcome ‚Äî click Connect Wallet. Chat unlocks only if your wallet holds the configured NFT.');

(async ()=>{
  await loadRarityTable(); 
  await restoreWalletConnection();
  await restoreSession();
  await autoAuthIfNeeded();
})();
</script>
</body>
</html>
