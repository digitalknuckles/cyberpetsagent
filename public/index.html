<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cyberpets AI</title>
<style>
body{margin:0;font-family:Inter,system-ui;background:#0b1020;color:#e6eef8}
.app{max-width:720px;margin:auto;height:100vh;display:flex;flex-direction:column}
header{padding:14px 16px;display:flex;align-items:center;gap:12px}
.brand{font-weight:700;font-size:18px}
.subtitle{font-size:12px;color:#94a3b8}
main{flex:1;overflow:auto;padding:12px}
.msg{max-width:80%;margin:8px 0;padding:12px;border-radius:14px}
.user{align-self:flex-end;background:linear-gradient(135deg,#7c3aed,#06b6d4)}
.ai{align-self:flex-start;background:#111827}
.meta{font-size:12px;color:#94a3b8;margin-bottom:4px}
.composer{padding:12px;border-top:1px solid rgba(255,255,255,.05)}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #222;background:#000;color:white}
button{margin-top:8px;padding:10px;border-radius:12px;border:none;background:#7c3aed;color:white;font-weight:700}
.loading{height:10px;width:40%;background:#333;border-radius:6px}
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <div class="brand">Cyberpets AI</div>
    <div class="subtitle">NFT-gated assistant</div>
  </div>
  <button id="connect">Connect Wallet</button>
</header>

<main id="chat"></main>

<div class="composer">
  <input id="input" disabled placeholder="NFT required"/>
  <button id="send" disabled>Send</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const NFT_CONTRACT="0x1C37df48Fa365B1802D0395eE9F7Db842726Eb81";
const ABI=[
 "function balanceOf(address owner)view returns(uint256)"
];

const chat=document.getElementById("chat");
const input=document.getElementById("input");
const send=document.getElementById("send");
const connect=document.getElementById("connect");

let signer,address;

function msg(who,text){
 const d=document.createElement("div");
 d.className="msg "+(who==="You"?"user":"ai");
 d.innerHTML=`<div class=meta>${who}</div>${text}`;
 chat.appendChild(d);
 chat.scrollTop=chat.scrollHeight;
 return d;
}

async function connectWallet(){
 if(!window.ethereum)return alert("Install MetaMask");
 const provider=new ethers.providers.Web3Provider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer=provider.getSigner();
 address=(await signer.getAddress()).toLowerCase();

 // Polygon only
 await window.ethereum.request({
  method:"wallet_switchEthereumChain",
  params:[{chainId:"0x89"}]
 });

 const contract=new ethers.Contract(NFT_CONTRACT,ABI,provider);
 const bal=await contract.balanceOf(address);
 if(bal.eq(0)){
   msg("System","‚ùå NFT required");
   return;
 }

 // Cookie auth
 await fetch("/api/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address})});

 input.disabled=false;
 send.disabled=false;
 msg("System","üîì Chat unlocked");
}

async function sendMsg(){
 const text=input.value.trim();
 if(!text)return;
 input.value="";
 msg("You",text);
 const bubble=msg("AI","<div class=loading></div>");

 const r=await fetch("/api/chat",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  credentials:"include",
  body:JSON.stringify({input:text})
 });

 const reader=r.body.getReader();
 const dec=new TextDecoder();
 bubble.innerHTML="<div class=meta>AI</div>";
 while(true){
  const {value,done}=await reader.read();
  if(done)break;
  bubble.innerHTML+=dec.decode(value);
  chat.scrollTop=chat.scrollHeight;
 }
}

connect.onclick=connectWallet;
send.onclick=sendMsg;
</script>
</body>
</html>
